pipeline {
  agent { label 'linux' }
  environment {
   ANSIBLE_PRIVATE_KEY=credentials('mariadb-private-key') 
  }
  stages {
    stage('Setup virtualenv') {
      steps {
        sh 'python3 -m venv venv'
        sh 'source venv/bin/activate'
      }
    }
    stage('Clean working dir') {
      steps {
        sh 'rm -rf kubespray'
      }
    }
    stage('Clone kubespray repo') {
      steps {
        sh 'git clone https://github.com/kubernetes-sigs/kubespray.git; echo "Kubespray repository cloned"'
      }
    }
    stage('Switch to version 2.17') {
      steps {
        sh 'cd kubespray'
        sh 'git fetch'
        sh 'git branch --all'
        sh 'git checkout release-2.17'
        sh 'git branch'
      }  
    }
    stage('Install Ansible Requirement') {
      steps {
        sh 'pip install -r requirements.txt'
      }
    }
    stage('Setup Ansible Inventory') {
      steps {
        sh 'cp -rfp inventory/sample inventory/mycluster'
        sh 'declare -a IPS=(192.168.2.187 192.168.2.158 192.168.2.195)'
        sh 'CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}'
      }
    }
    stage('Deploy Kubespray') {
      steps {
        sh 'ansible-playbook -i inventory/mycluster/hosts.yaml --private-key=$ANSIBLE_PRIVATE_KEY --become --become-user=ubuntu cluster.yml'
      }
    }
  }
}
